<project_specification>
<project_name>RealHibachiWeb - Growth Ops & Attribution System</project_name>

<overview> Build a web application for a local service business (Real Hibachi) that implements an end-to-end growth operating system: traffic attribution, lead capture, quoting/offer packaging, customer communication workflows, delivery/SOP tracking, review collection, and negative review prevention/remediation. The system must support measurable experiments (before/after or A/B) and provide a clear, low-friction customer experience that does not reduce conversion rates. The UI should be clean, modern, and mobile-first with an emphasis on speed, clarity, and operational reliability. </overview>

<technology_stack>

<api_key>
You can use an API key located at /tmp/api-key for testing. You will not be allowed to read this file, but you can reference it in code.
</api_key>

<frontend>
<framework>React with Vite</framework>
<styling>Tailwind CSS (via CDN)</styling>
<state_management>React hooks and context</state_management>
<routing>React Router for navigation</routing>
<markdown>React Markdown for message rendering (for SOP/docs/templates)</markdown>
<port>Only launch on port {frontend_port}</port>
</frontend>

<backend>
<runtime>Next.js (Node runtime)</runtime>
<database>supabase</database>
<api_integration>
- Google Analytics (optional) / server-side event logging
- Google Business Profile (optional, later) for review signals
- Twilio (optional, later) for SMS workflows
</api_integration>
<streaming>Server-Sent Events (optional) for real-time dashboards/notifications</streaming>
</backend>

<communication>
<api>RESTful endpoints</api>
<streaming>SSE for real-time events (optional)</streaming>
</communication>
</technology_stack>

<prerequisites> <environment_setup> - Repository includes .env with VITE_* variables configured - Frontend dependencies pre-installed via pnpm - Backend code goes in /server directory - Install backend dependencies as needed </environment_setup> </prerequisites>

<core_features>
<chat_interface>
- (Replace chat with) Lead Inbox: a clean, centered inbox for leads and customer threads
- Unified thread view for SMS/calls/web form leads (call entries can be manual)
- Quick reply templates (scripts) with one-click insertion
- Low-friction "source attribution" prompt that does not block conversion
- Typing indicator / pending states for automation actions (optional)
- Keyboard shortcuts (Enter to send, Shift+Enter for newline) for fast ops
</chat_interface>

<artifacts>
  - (Replace artifacts with) Templates & SOP panel
  - Script template viewer (first reply / follow-up / deposit request / arrival confirmation / post-event review ask)
  - Offer/quote template viewer (packages, add-ons, travel fees, deposit policy)
  - SOP checklist templates (pre-event, on-site, post-event)
  - Versioning for templates (history of edits)
  - Download/export templates (Markdown/PDF)
</artifacts>

<conversation_management>
  - (Replace conversations with) Lead/Order lifecycle management
  - Create new lead from web form, manual call entry, or imported SMS (later)
  - Lead list in sidebar with statuses: New, Contacted, Quoted, Deposit Pending, Booked, Completed, Review Requested, Closed/Lost
  - Rename lead (customer name + event date + city)
  - Archive/close lost leads with reason tags
  - Search leads by name/phone/event city/date/source
  - Pin important leads
  - Export lead timeline (JSON, Markdown, PDF)
  - Timestamps (created, last updated, last contact)
  - Unread indicators for new inbound messages (optional)
</conversation_management>

<projects>
  - (Replace projects with) Campaigns & Channels
  - Create channels/campaigns to group attribution and experiments (Google Ads, Google Maps, Organic, Yelp, Referral, Instagram/TikTok, Unknown)
  - Campaign settings: UTM rules, landing pages, tracking numbers (optional)
  - Move leads between campaigns (if re-attributed)
  - Campaign analytics: lead volume, close rate, margin estimate by source
</projects>

<model_selection>
  - (Replace model selection with) Offer/Package selection
  - Offer selector dropdown with standard packages
  - Add-on selector (extra proteins, tableware, travel fee tiers)
  - Pricing summary display (estimate)
  - Switch offer mid-thread (re-quote)
  - Offer comparison view (display only)
</model_selection>

<custom_instructions>
  - (Replace custom instructions with) Business rules & guardrails
  - Global business rules: service radius, minimum spend, deposit policy, cancellation policy
  - Campaign-specific rules: promos, targeting constraints
  - Lead-specific notes: special requests, risk flags
  - Rule templates and previews (how rules affect quotes/messages)
</custom_instructions>

<settings_preferences>
  - Theme selection (Light, Dark, Auto)
  - Message density (compact, comfortable, spacious)
  - Language preferences (EN/中文) for templates
  - Accessibility options
  - Data export options
  - Privacy settings
  - API integrations management (optional modules)
</settings_preferences>

<advanced_features>
  - A/B test toggles for landing page modules (trust block, pricing anchor, CTA wording)
  - Experiment tagging: before/after windows and notes
  - "Attribution confidence" field (Direct/Asked/UTM/Guessed)
  - Multi-modal input (text + images) for customer reference photos (optional)
  - Voice input (optional, mock UI)
  - Response suggestions for ops team (template recommendations)
  - Conversation branching (quote v1 / quote v2)
</advanced_features>

<collaboration>
  - Share quote via link (read-only)
  - Export quote as PDF
  - Template library sharing (mock UI)
  - Team workspaces (mock UI)
  - Audit log of template edits
</collaboration>

<search_discovery>
  - Search across all leads/orders/messages/templates
  - Filter by channel, date, status, event city
  - Template library with categories (First Reply, Quote, Deposit, Confirmation, Review Ask, Remediation)
  - Quick actions menu
  - Command palette (Cmd/Ctrl+K)
</search_discovery>

<usage_tracking>
  - (Replace token usage with) KPI tracking
  - Lead counts per day/week/month by channel
  - Close rate by channel
  - Avg time-to-first-response and SLA compliance
  - Quote-to-deposit conversion
  - Estimated margin by channel (manual input ok)
  - Review request rate and review outcome tracking (manual)
</usage_tracking>

<onboarding>
  - Welcome screen for new ops user
  - Setup tour: define offers, deposit policy, service radius, UTM rules
  - Example templates to get started
  - Quick tips and best practices (low-friction attribution question)
</onboarding>

<accessibility>
  - Full keyboard navigation
  - Screen reader support
  - ARIA labels and roles
  - High contrast mode
  - Focus management
  - Reduced motion support
</accessibility>

<responsive_design>
  - Mobile-first responsive layout for on-the-go ops
  - Collapsible sidebar on mobile
  - Touch-optimized interface
  - Progressive Web App (PWA) support (optional)
</responsive_design>


</core_features>

<database_schema>
<tables>
<users>
- id, email, name, avatar_url
- created_at, last_login
- preferences (JSON: theme, density, language, etc.)
</users>

  <channels>
    - id, user_id, name (Google Ads, Google Maps, Organic, Yelp, Referral, Social, Unknown)
    - utm_rules (JSON)
    - created_at, updated_at
    - is_archived, is_pinned
  </channels>

  <campaigns>
    - id, user_id, channel_id, name, description
    - landing_page, notes
    - created_at, updated_at
    - is_archived, is_pinned
  </campaigns>

  <leads>
    - id, user_id, campaign_id, channel_id
    - title (customer + date + city)
    - customer_name, phone, email
    - event_date, event_city, event_address (optional)
    - status (new/contacted/quoted/deposit_pending/booked/completed/review_requested/closed_lost)
    - source_raw (string), attribution_confidence (utm/asked/guessed/unknown)
    - created_at, updated_at, last_contact_at
    - lost_reason (optional)
    - notes (JSON)
  </leads>

  <messages>
    - id, lead_id, role (customer/ops/system)
    - channel (sms/phone/web/email)  // phone entries can be manual logs
    - content, created_at, edited_at
    - attachments (JSON array, optional)
  </messages>

  <quotes>
    - id, lead_id
    - offer_id, offer_snapshot (JSON)
    - price_estimate, travel_fee, add_ons (JSON)
    - deposit_required, deposit_amount
    - status (draft/sent/accepted/expired)
    - created_at, updated_at
  </quotes>

  <offers>
    - id, user_id, name
    - base_price_rules (JSON)
    - add_on_catalog (JSON)
    - deposit_policy (JSON)
    - cancellation_policy (JSON)
    - service_radius_policy (JSON)
    - created_at, updated_at
    - is_active
  </offers>

  <templates>
    - id, user_id, category (first_reply/quote/deposit/confirm/review/remediation/sop)
    - title, language (en/zh)
    - content (markdown)
    - version, created_at, updated_at
  </templates>

  <deliveries>
    - id, lead_id
    - assigned_staff (JSON)
    - sop_checklist (JSON)
    - status (planned/in_progress/completed)
    - issues (JSON)
    - created_at, updated_at
  </deliveries>

  <reviews>
    - id, lead_id
    - platform (google/yelp/other)
    - requested_at, received_at
    - rating (1-5, nullable)
    - url (nullable)
    - remediation_status (none/in_progress/resolved)
    - notes
  </reviews>

  <experiments>
    - id, user_id, name
    - target (landing/offer/script)
    - variant_a (JSON), variant_b (JSON)
    - start_at, end_at
    - success_metric (string)
    - notes
  </experiments>

  <events>
    - id, user_id, lead_id (nullable)
    - event_type (page_view/cta_click/form_submit/call_click/whatsapp_click/source_answered/quote_sent/deposit_requested/deposit_received/review_requested/review_received)
    - payload (JSON)
    - created_at
  </events>
</tables>


</database_schema>

<api_endpoints_summary>
<authentication>
- POST /api/auth/login
- POST /api/auth/logout
- GET /api/auth/me
- PUT /api/auth/profile
</authentication>

<channels_campaigns>
  - GET /api/channels
  - POST /api/channels
  - PUT /api/channels/:id
  - DELETE /api/channels/:id
  - GET /api/campaigns
  - POST /api/campaigns
  - PUT /api/campaigns/:id
  - DELETE /api/campaigns/:id
</channels_campaigns>

<leads>
  - GET /api/leads
  - POST /api/leads
  - GET /api/leads/:id
  - PUT /api/leads/:id
  - DELETE /api/leads/:id
  - PUT /api/leads/:id/status
  - POST /api/leads/:id/export
  - POST /api/leads/:id/duplicate  (optional)
</leads>

<messages>
  - GET /api/leads/:id/messages
  - POST /api/leads/:id/messages
  - PUT /api/messages/:id
  - DELETE /api/messages/:id
</messages>

<quotes_offers>
  - GET /api/offers
  - POST /api/offers
  - GET /api/offers/:id
  - PUT /api/offers/:id
  - GET /api/leads/:id/quotes
  - POST /api/leads/:id/quotes
  - PUT /api/quotes/:id
  - POST /api/quotes/:id/send
  - POST /api/quotes/:id/accept  (manual action)
</quotes_offers>

<templates_sop>
  - GET /api/templates
  - POST /api/templates
  - GET /api/templates/:id
  - PUT /api/templates/:id
  - DELETE /api/templates/:id
  - GET /api/templates/:id/versions
</templates_sop>

<delivery>
  - GET /api/leads/:id/delivery
  - POST /api/leads/:id/delivery
  - PUT /api/delivery/:id
  - POST /api/delivery/:id/checklist/complete-item
</delivery>

<reviews>
  - GET /api/leads/:id/reviews
  - POST /api/leads/:id/reviews/request
  - POST /api/leads/:id/reviews/record
  - PUT /api/reviews/:id
</reviews>

<experiments>
  - GET /api/experiments
  - POST /api/experiments
  - PUT /api/experiments/:id
  - POST /api/experiments/:id/close
</experiments>

<events_tracking>
  - POST /api/events
  - GET /api/analytics/summary
  - GET /api/analytics/by-channel
  - GET /api/analytics/by-campaign
  - GET /api/analytics/sla
</events_tracking>

<settings>
  - GET /api/settings
  - PUT /api/settings
</settings>


</api_endpoints_summary>

<ui_layout>
<main_structure>
- Three-column layout: sidebar (leads), main (lead thread + quote), panel (templates/SOP/analytics)
- Collapsible sidebar with resize handle
- Responsive breakpoints: mobile (single column), tablet (two column), desktop (three column)
- Persistent header with channel/campaign selector and quick actions
- Bottom input area for replies + quick template insert
</main_structure>

<sidebar_left>
  - New lead button (prominent)
  - Channel/Campaign selector dropdown
  - Search leads input
  - Leads list grouped by status/date
  - Settings gear icon at bottom
  - User profile at bottom
</sidebar_left>

<main_chat_area>
  - Lead title (editable inline)
  - Status badge + SLA indicator
  - Message history (scrollable)
  - Quote panel (estimate, deposit, send)
  - Input area with template toolbar
  - Attachment button for images (optional)
  - Send button with loading state
</main_chat_area>

<artifacts_panel>
  - (Replace artifacts with) Templates/SOP/Analytics panel
  - Tabs: Templates, SOP, Experiments, Analytics
  - Template editor with version selector
  - SOP checklist runner
  - Analytics cards (by channel, SLA, close rate)
  - Close panel button
</artifacts_panel>

<modals_overlays>
  - Settings modal (tabbed interface)
  - Export modal (lead/quote/templates)
  - Campaign settings modal
  - Template library modal
  - Command palette overlay
  - Keyboard shortcuts reference
</modals_overlays>


</ui_layout>

<design_system>
<color_palette>
- Primary: Orange/amber accent (#CC785C)
- Background: White (light mode), Dark gray (#1A1A1A dark mode)
- Surface: Light gray (#F5F5F5 light), Darker gray (#2A2A2A dark)
- Text: Near black (#1A1A1A light), Off-white (#E5E5E5 dark)
- Borders: Light gray (#E5E5E5 light), Dark gray (#404040 dark)
- Code blocks: Monaco theme (optional for templates)
</color_palette>

<typography>
  - Sans-serif system font stack (Inter, SF Pro, Roboto, system-ui)
  - Headings: font-semibold
  - Body: font-normal, leading-relaxed
  - Message text: text-base (16px), comfortable line-height
</typography>

<components>
  <message_bubble>
    - Customer messages: Left-aligned with subtle background
    - Ops messages: Right-aligned, subtle background
    - Template chips for quick insert
  </message_bubble>

  <buttons>
    - Primary: Orange/amber background, white text, rounded
    - Secondary: Border style with hover fill
    - Icon buttons: Square with hover background
  </buttons>

  <inputs>
    - Rounded borders with focus ring
    - Textarea auto-resize
    - Placeholder text in gray
    - Character counter (optional)
  </inputs>

  <cards>
    - Subtle border or shadow
    - Rounded corners (8px)
    - Padding: p-4 to p-6
  </cards>
</components>

<animations>
  - Smooth transitions (150-300ms)
  - Slide in for sidebar/panel
  - Loading spinner for actions
  - Skeleton loaders for lists
</animations>


</design_system>

<key_interactions>
<message_flow>
1. Lead arrives via web form or manual creation (call/text)
2. Ops replies using template or custom message
3. Optional: ask low-friction attribution question (Google/Maps/Referral/Ads)
4. Build quote using offer selector + add-ons
5. Send quote + deposit request
6. Update status as lead progresses
7. After completion, trigger review request template
8. If negative signal, trigger remediation workflow
</message_flow>

<artifact_flow>
  1. Ops opens Templates/SOP panel
  2. Selects a template category (First Reply, Quote, Deposit, Confirm, Review, Remediation, SOP)
  3. Inserts template into message composer
  4. Edits and sends
  5. Template changes saved as new version (optional)
</artifact_flow>

<conversation_management>
  1. Click "New Lead" to create lead
  2. Leads auto-save on first message/quote
  3. Rename lead inline
  4. Status transitions via quick actions
  5. Search filters leads in real-time
  6. Export lead timeline or quote
</conversation_management>


</key_interactions>

<implementation_steps>
<step number="1">
<title>Setup Project Foundation and Database</title>
<tasks>
- Initialize Express server with SQLite database
- Create schema for leads, messages, offers, quotes, templates, events
- Set up basic auth (single user acceptable for MVP)
- Create health check endpoint
- Implement event logging endpoint (/api/events)
</tasks>
</step>

<step number="2">
  <title>Build Lead Inbox and Thread View</title>
  <tasks>
    - Main layout with sidebar lead list and main thread view
    - Message display + template insertion toolbar
    - Lead status badge and SLA timer
    - CRUD for leads and messages
  </tasks>
</step>

<step number="3">
  <title>Attribution & Tracking (MVP)</title>
  <tasks>
    - UTM parsing and persistent storage on lead creation
    - Track CTA clicks (call/text/whatsapp/form) via /api/events
    - Add "source attribution" quick question flow (optional, non-blocking)
    - Analytics summary endpoints: leads by channel, close rate, SLA
  </tasks>
</step>

<step number="4">
  <title>Offer & Quote Engine (MVP)</title>
  <tasks>
    - Offer editor (packages, add-ons, deposit rules)
    - Quote builder on lead thread
    - Quote versioning (quote v1/v2)
    - Export quote (PDF later; Markdown/JSON first)
  </tasks>
</step>

<step number="5">
  <title>Templates + SOP System</title>
  <tasks>
    - Template library CRUD + version history
    - SOP checklist runner for delivery stages
    - Post-event review request workflow templates
    - Remediation workflow templates (24h response, make-good options)
  </tasks>
</step>

<step number="6">
  <title>Experiments & Optimization</title>
  <tasks>
    - Experiment tagging for landing/offer/script variants
    - Before/after reporting windows
    - Basic dashboard cards
  </tasks>
</step>

<step number="7">
  <title>Settings and Customization</title>
  <tasks>
    - Theme + density + language
    - Business rules configuration (radius/min spend/deposit)
    - Export options (lead/quote/templates)
  </tasks>
</step>

<step number="8">
  <title>Integrations (Optional / Later)</title>
  <tasks>
    - Twilio for SMS send/receive
    - Google Business Profile for reviews signals
    - Call tracking numbers per campaign
  </tasks>
</step>

<step number="9">
  <title>Polish and Optimization</title>
  <tasks>
    - Mobile UX improvements
    - Keyboard shortcuts + command palette
    - Performance optimizations
    - Accessibility improvements
  </tasks>
</step>


</implementation_steps>

<success_criteria>
<functionality>
- Leads and messages CRUD reliable
- UTM and source attribution captured without blocking conversion
- Quote creation and status progression workable for daily operations
- Templates and SOP usable and versioned
- Analytics provides actionable channel-level insights
</functionality>

<user_experience>
  - Fast, low-friction workflow for handling inbound leads
  - Clear quoting flow and next-step prompts
  - Mobile-friendly for field operations
  - Minimal cognitive load and fast keyboard-driven ops
</user_experience>

<technical_quality>
  - Clean, maintainable code structure
  - Proper error handling
  - Secure handling of any API keys and PII
  - Efficient database queries
  - Event logging is durable and queryable
</technical_quality>

<design_polish>
  - Consistent visual language
  - Great typography and spacing
  - Smooth transitions
  - Dark mode implemented
  - Professional appearance
</design_polish>


</success_criteria>
</project_specification>